/* 
 * This file is part of Stack Wallet.
 * 
 * Copyright (c) 2023 Cypher Stack
 * All Rights Reserved.
 * The code is distributed under GPLv3 license, see LICENSE file for details.
 * Generated by Cypher Stack on 2023-05-26
 *
 */

import 'dart:async';

import 'package:flutter/foundation.dart';
import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:flutter_svg/flutter_svg.dart';
import 'package:stackwallet/models/isar/models/blockchain_data/transaction.dart';
import 'package:stackwallet/models/isar/models/blockchain_data/v2/transaction_v2.dart';
import 'package:stackwallet/notifications/show_flush_bar.dart';
import 'package:stackwallet/pages/wallet_view/sub_widgets/tx_icon.dart';
import 'package:stackwallet/pages/wallet_view/transaction_views/edit_note_view.dart';
import 'package:stackwallet/providers/global/address_book_service_provider.dart';
import 'package:stackwallet/providers/providers.dart';
import 'package:stackwallet/themes/stack_colors.dart';
import 'package:stackwallet/utilities/amount/amount.dart';
import 'package:stackwallet/utilities/amount/amount_formatter.dart';
import 'package:stackwallet/utilities/assets.dart';
import 'package:stackwallet/utilities/block_explorers.dart';
import 'package:stackwallet/utilities/constants.dart';
import 'package:stackwallet/utilities/enums/coin_enum.dart';
import 'package:stackwallet/utilities/format.dart';
import 'package:stackwallet/utilities/logger.dart';
import 'package:stackwallet/utilities/text_styles.dart';
import 'package:stackwallet/utilities/util.dart';
import 'package:stackwallet/wallets/isar/providers/wallet_info_provider.dart';
import 'package:stackwallet/wallets/wallet/wallet_mixin_interfaces/spark_interface.dart';
import 'package:stackwallet/widgets/background.dart';
import 'package:stackwallet/widgets/conditional_parent.dart';
import 'package:stackwallet/widgets/custom_buttons/app_bar_icon_button.dart';
import 'package:stackwallet/widgets/custom_buttons/blue_text_button.dart';
import 'package:stackwallet/widgets/desktop/desktop_dialog.dart';
import 'package:stackwallet/widgets/desktop/desktop_dialog_close_button.dart';
import 'package:stackwallet/widgets/desktop/primary_button.dart';
import 'package:stackwallet/widgets/desktop/secondary_button.dart';
import 'package:stackwallet/widgets/icon_widgets/copy_icon.dart';
import 'package:stackwallet/widgets/icon_widgets/pencil_icon.dart';
import 'package:stackwallet/widgets/rounded_white_container.dart';
import 'package:stackwallet/widgets/stack_dialog.dart';
import 'package:tuple/tuple.dart';
import 'package:url_launcher/url_launcher.dart';

class TransactionV2DetailsView extends ConsumerStatefulWidget {
  const TransactionV2DetailsView({
    Key? key,
    required this.transaction,
    required this.walletId,
    required this.coin,
  }) : super(key: key);

  static const String routeName = "/transactionV2Details";

  final TransactionV2 transaction;
  final String walletId;
  final Coin coin;

  @override
  ConsumerState<TransactionV2DetailsView> createState() =>
      _TransactionV2DetailsViewState();
}

class _TransactionV2DetailsViewState
    extends ConsumerState<TransactionV2DetailsView> {
  late final bool isDesktop;
  late TransactionV2 _transaction;
  late final String walletId;

  late final Coin coin;
  late final Amount amount;
  late final Amount fee;
  late final String amountPrefix;
  late final String unit;
  late final int minConfirms;

  late final List<({List<String> addresses, Amount amount})> data;

  bool showFeePending = false;

  @override
  void initState() {
    isDesktop = Util.isDesktop;
    _transaction = widget.transaction;
    walletId = widget.walletId;

    coin = widget.coin;
    minConfirms =
        ref.read(pWallets).getWallet(walletId).cryptoCurrency.minConfirms;

    fee = _transaction.getFee(coin: coin);

    if (_transaction.subType == TransactionSubType.cashFusion ||
        _transaction.type == TransactionType.sentToSelf) {
      amountPrefix = "";
    } else {
      amountPrefix = _transaction.type == TransactionType.outgoing ? "-" : "+";
    }

    unit = coin.ticker;

    if (_transaction.subType == TransactionSubType.cashFusion) {
      amount = _transaction.getAmountReceivedInThisWallet(coin: coin);
      data = _transaction.outputs
          .where((e) => e.walletOwns)
          .map((e) => (
                addresses: e.addresses,
                amount: Amount(rawValue: e.value, fractionDigits: coin.decimals)
              ))
          .toList();
    } else {
      switch (_transaction.type) {
        case TransactionType.outgoing:
          amount = _transaction.getAmountSentFromThisWallet(coin: coin);
          data = _transaction.outputs
              .where((e) => !e.walletOwns)
              .map((e) => (
                    addresses: e.addresses,
                    amount:
                        Amount(rawValue: e.value, fractionDigits: coin.decimals)
                  ))
              .toList();
          break;

        case TransactionType.incoming:
        case TransactionType.sentToSelf:
          if (_transaction.subType == TransactionSubType.sparkMint) {
            amount = _transaction.getAmountSparkSelfMinted(coin: coin);
          } else if (_transaction.subType == TransactionSubType.sparkSpend) {
            final changeAddress =
                (ref.read(pWallets).getWallet(walletId) as SparkInterface)
                    .sparkChangeAddress;
            amount = Amount(
              rawValue: _transaction.outputs
                  .where((e) =>
                      e.walletOwns && !e.addresses.contains(changeAddress))
                  .fold(BigInt.zero, (p, e) => p + e.value),
              fractionDigits: coin.decimals,
            );
          } else {
            amount = _transaction.getAmountReceivedInThisWallet(coin: coin);
          }
          data = _transaction.outputs
              .where((e) => e.walletOwns)
              .map((e) => (
                    addresses: e.addresses,
                    amount:
                        Amount(rawValue: e.value, fractionDigits: coin.decimals)
                  ))
              .toList();
          break;

        case TransactionType.unknown:
          amount = _transaction.getAmountSentFromThisWallet(coin: coin);
          data = _transaction.inputs
              .where((e) => e.walletOwns)
              .map((e) => (
                    addresses: e.addresses,
                    amount:
                        Amount(rawValue: e.value, fractionDigits: coin.decimals)
                  ))
              .toList();
          break;
      }
    }

    super.initState();
  }

  @override
  void dispose() {
    super.dispose();
  }

  String whatIsIt(TransactionV2 tx, int height) => tx.statusLabel(
        currentChainHeight: height,
        minConfirms: minConfirms,
      );

  Future<String> fetchContactNameFor(String address) async {
    if (address.isEmpty) {
      return address;
    }
    try {
      final contacts = ref.read(addressBookServiceProvider).contacts.where(
          (element) => element.addresses
              .where((element) => element.address == address)
              .isNotEmpty);
      if (contacts.isNotEmpty) {
        return contacts.first.name;
      } else {
        return address;
      }
    } catch (e, s) {
      Logging.instance.log("$e\n$s", level: LogLevel.Warning);
      return address;
    }
  }

  Future<bool> showExplorerWarning(String explorer) async {
    final bool? shouldContinue = await showDialog<bool>(
        context: context,
        barrierDismissible: false,
        builder: (_) {
          if (!isDesktop) {
            return StackDialog(
              title: "Attention",
              message:
                  "You are about to view this transaction in a block explorer. The explorer may log your IP address and link it to the transaction. Only proceed if you trust $explorer.",
              icon: Row(
                children: [
                  Consumer(builder: (_, ref, __) {
                    return Checkbox(
                      value: ref.watch(prefsChangeNotifierProvider
                          .select((value) => value.hideBlockExplorerWarning)),
                      onChanged: (value) {
                        if (value is bool) {
                          ref
                              .read(prefsChangeNotifierProvider)
                              .hideBlockExplorerWarning = value;
                          setState(() {});
                        }
                      },
                    );
                  }),
                  Text(
                    "Never show again",
                    style: STextStyles.smallMed14(context),
                  )
                ],
              ),
              leftButton: TextButton(
                onPressed: () {
                  Navigator.of(context).pop(false);
                },
                child: Text(
                  "Cancel",
                  style: STextStyles.button(context).copyWith(
                      color: Theme.of(context)
                          .extension<StackColors>()!
                          .accentColorDark),
                ),
              ),
              rightButton: TextButton(
                style: Theme.of(context)
                    .extension<StackColors>()!
                    .getPrimaryEnabledButtonStyle(context),
                onPressed: () {
                  Navigator.of(context).pop(true);
                },
                child: Text(
                  "Continue",
                  style: STextStyles.button(context),
                ),
              ),
            );
          } else {
            return DesktopDialog(
              maxWidth: 550,
              maxHeight: 300,
              child: Padding(
                padding:
                    const EdgeInsets.symmetric(horizontal: 32, vertical: 20),
                child: Column(
                  children: [
                    Row(
                      mainAxisAlignment: MainAxisAlignment.spaceBetween,
                      children: [
                        Text(
                          "Attention",
                          style: STextStyles.desktopH2(context),
                        ),
                        Row(
                          children: [
                            Consumer(builder: (_, ref, __) {
                              return Checkbox(
                                value: ref.watch(prefsChangeNotifierProvider
                                    .select((value) =>
                                        value.hideBlockExplorerWarning)),
                                onChanged: (value) {
                                  if (value is bool) {
                                    ref
                                        .read(prefsChangeNotifierProvider)
                                        .hideBlockExplorerWarning = value;
                                    setState(() {});
                                  }
                                },
                              );
                            }),
                            Text(
                              "Never show again",
                              style: STextStyles.smallMed14(context),
                            )
                          ],
                        ),
                      ],
                    ),
                    const SizedBox(height: 16),
                    Text(
                      "You are about to view this transaction in a block explorer. The explorer may log your IP address and link it to the transaction. Only proceed if you trust $explorer.",
                      style: STextStyles.desktopTextSmall(context),
                    ),
                    const SizedBox(height: 35),
                    Row(
                      mainAxisAlignment: MainAxisAlignment.center,
                      children: [
                        SecondaryButton(
                          width: 200,
                          buttonHeight: ButtonHeight.l,
                          label: "Cancel",
                          onPressed: () {
                            Navigator.of(
                              context,
                              rootNavigator: true,
                            ).pop(false);
                          },
                        ),
                        const SizedBox(width: 20),
                        PrimaryButton(
                          width: 200,
                          buttonHeight: ButtonHeight.l,
                          label: "Continue",
                          onPressed: () {
                            Navigator.of(
                              context,
                              rootNavigator: true,
                            ).pop(true);
                          },
                        ),
                      ],
                    ),
                  ],
                ),
              ),
            );
          }
        });
    return shouldContinue ?? false;
  }

  @override
  Widget build(BuildContext context) {
    final currentHeight = ref.watch(pWalletChainHeight(walletId));

    final String outputLabel;

    if (_transaction.subType == TransactionSubType.cashFusion) {
      outputLabel = "Outputs";
    } else if (_transaction.type == TransactionType.incoming) {
      if (data.length == 1 && data.first.addresses.length == 1) {
        outputLabel = "Receiving address";
      } else {
        outputLabel = "Receiving addresses";
      }
    } else {
      outputLabel = "Sent to";
    }

    return ConditionalParent(
      condition: !isDesktop,
      builder: (child) => Background(
        child: child,
      ),
      child: Scaffold(
        backgroundColor: isDesktop
            ? Colors.transparent
            : Theme.of(context).extension<StackColors>()!.background,
        appBar: isDesktop
            ? null
            : AppBar(
                backgroundColor:
                    Theme.of(context).extension<StackColors>()!.background,
                leading: AppBarBackButton(
                  onPressed: () async {
                    // if (FocusScope.of(context).hasFocus) {
                    //   FocusScope.of(context).unfocus();
                    //   await Future<void>.delayed(Duration(milliseconds: 50));
                    // }
                    Navigator.of(context).pop();
                  },
                ),
                title: Text(
                  "Transaction details",
                  style: STextStyles.navBarTitle(context),
                ),
              ),
        body: Padding(
          padding: isDesktop
              ? const EdgeInsets.only(left: 32)
              : const EdgeInsets.all(12),
          child: Column(
            mainAxisSize: MainAxisSize.min,
            children: [
              if (isDesktop)
                Row(
                  mainAxisAlignment: MainAxisAlignment.spaceBetween,
                  children: [
                    Text(
                      "Transaction details",
                      style: STextStyles.desktopH3(context),
                    ),
                    const DesktopDialogCloseButton(),
                  ],
                ),
              Flexible(
                child: Padding(
                  padding: isDesktop
                      ? const EdgeInsets.only(
                          right: 32,
                          bottom: 32,
                        )
                      : const EdgeInsets.all(0),
                  child: ConditionalParent(
                    condition: isDesktop,
                    builder: (child) {
                      return RoundedWhiteContainer(
                        borderColor: isDesktop
                            ? Theme.of(context)
                                .extension<StackColors>()!
                                .backgroundAppBar
                            : null,
                        padding: const EdgeInsets.all(0),
                        child: child,
                      );
                    },
                    child: SingleChildScrollView(
                      primary: isDesktop ? false : null,
                      child: Padding(
                        padding: isDesktop
                            ? const EdgeInsets.all(0)
                            : const EdgeInsets.all(4),
                        child: Column(
                          mainAxisSize: MainAxisSize.min,
                          crossAxisAlignment: CrossAxisAlignment.stretch,
                          children: [
                            RoundedWhiteContainer(
                              padding: isDesktop
                                  ? const EdgeInsets.all(0)
                                  : const EdgeInsets.all(12),
                              child: Container(
                                decoration: isDesktop
                                    ? BoxDecoration(
                                        color: Theme.of(context)
                                            .extension<StackColors>()!
                                            .backgroundAppBar,
                                        borderRadius: BorderRadius.vertical(
                                          top: Radius.circular(
                                            Constants.size.circularBorderRadius,
                                          ),
                                        ),
                                      )
                                    : null,
                                child: Padding(
                                  padding: isDesktop
                                      ? const EdgeInsets.all(12)
                                      : const EdgeInsets.all(0),
                                  child: Row(
                                    mainAxisAlignment:
                                        MainAxisAlignment.spaceBetween,
                                    children: [
                                      if (isDesktop)
                                        Row(
                                          children: [
                                            TxIcon(
                                              transaction: _transaction,
                                              currentHeight: currentHeight,
                                              coin: coin,
                                            ),
                                            const SizedBox(
                                              width: 16,
                                            ),
                                            SelectableText(
                                              whatIsIt(
                                                _transaction,
                                                currentHeight,
                                              ),
                                              style:
                                                  STextStyles.desktopTextMedium(
                                                      context),
                                            ),
                                          ],
                                        ),
                                      Column(
                                        crossAxisAlignment: isDesktop
                                            ? CrossAxisAlignment.end
                                            : CrossAxisAlignment.start,
                                        children: [
                                          SelectableText(
                                            "$amountPrefix${ref.watch(pAmountFormatter(coin)).format(amount)}",
                                            style: isDesktop
                                                ? STextStyles
                                                        .desktopTextExtraExtraSmall(
                                                            context)
                                                    .copyWith(
                                                    color: Theme.of(context)
                                                        .extension<
                                                            StackColors>()!
                                                        .textDark,
                                                  )
                                                : STextStyles.titleBold12(
                                                    context),
                                          ),
                                          const SizedBox(
                                            height: 2,
                                          ),
                                          if (ref.watch(
                                              prefsChangeNotifierProvider
                                                  .select((value) =>
                                                      value.externalCalls)))
                                            SelectableText(
                                              "$amountPrefix${(amount.decimal * ref.watch(
                                                        priceAnd24hChangeNotifierProvider
                                                            .select((value) =>
                                                                value
                                                                    .getPrice(
                                                                        coin)
                                                                    .item1),
                                                      )).toAmount(fractionDigits: 2).fiatString(
                                                    locale: ref.watch(
                                                      localeServiceChangeNotifierProvider
                                                          .select(
                                                        (value) => value.locale,
                                                      ),
                                                    ),
                                                  )} ${ref.watch(
                                                prefsChangeNotifierProvider
                                                    .select(
                                                  (value) => value.currency,
                                                ),
                                              )}",
                                              style: isDesktop
                                                  ? STextStyles
                                                      .desktopTextExtraExtraSmall(
                                                          context)
                                                  : STextStyles.itemSubtitle(
                                                      context),
                                            ),
                                        ],
                                      ),
                                      if (!isDesktop)
                                        TxIcon(
                                          transaction: _transaction,
                                          currentHeight: currentHeight,
                                          coin: coin,
                                        ),
                                    ],
                                  ),
                                ),
                              ),
                            ),

                            isDesktop
                                ? const _Divider()
                                : const SizedBox(
                                    height: 12,
                                  ),
                            RoundedWhiteContainer(
                              padding: isDesktop
                                  ? const EdgeInsets.all(16)
                                  : const EdgeInsets.all(12),
                              child: Row(
                                mainAxisAlignment:
                                    MainAxisAlignment.spaceBetween,
                                children: [
                                  Text(
                                    "Status",
                                    style: isDesktop
                                        ? STextStyles
                                            .desktopTextExtraExtraSmall(context)
                                        : STextStyles.itemSubtitle(context),
                                  ),
                                  // Flexible(
                                  //   child: FittedBox(
                                  //     fit: BoxFit.scaleDown,
                                  //     child:
                                  SelectableText(
                                    whatIsIt(
                                      _transaction,
                                      currentHeight,
                                    ),
                                    style: isDesktop
                                        ? STextStyles
                                                .desktopTextExtraExtraSmall(
                                                    context)
                                            .copyWith(
                                            color: _transaction.type ==
                                                        TransactionType
                                                            .outgoing &&
                                                    _transaction.subType !=
                                                        TransactionSubType
                                                            .cashFusion
                                                ? Theme.of(context)
                                                    .extension<StackColors>()!
                                                    .accentColorOrange
                                                : Theme.of(context)
                                                    .extension<StackColors>()!
                                                    .accentColorGreen,
                                          )
                                        : STextStyles.itemSubtitle12(context),
                                  ),
                                  //   ),
                                  // ),
                                ],
                              ),
                            ),
                            if (!((coin == Coin.monero ||
                                        coin == Coin.wownero) &&
                                    _transaction.type ==
                                        TransactionType.outgoing) &&
                                !((coin == Coin.firo ||
                                        coin == Coin.firoTestNet) &&
                                    _transaction.subType ==
                                        TransactionSubType.mint))
                              isDesktop
                                  ? const _Divider()
                                  : const SizedBox(
                                      height: 12,
                                    ),
                            if (!((coin == Coin.monero ||
                                        coin == Coin.wownero) &&
                                    _transaction.type ==
                                        TransactionType.outgoing) &&
                                !((coin == Coin.firo ||
                                        coin == Coin.firoTestNet) &&
                                    _transaction.subType ==
                                        TransactionSubType.mint))
                              RoundedWhiteContainer(
                                padding: isDesktop
                                    ? const EdgeInsets.all(16)
                                    : const EdgeInsets.all(12),
                                child: Row(
                                  mainAxisAlignment:
                                      MainAxisAlignment.spaceBetween,
                                  crossAxisAlignment: CrossAxisAlignment.start,
                                  children: [
                                    Expanded(
                                      child: Column(
                                        crossAxisAlignment:
                                            CrossAxisAlignment.start,
                                        children: [
                                          ConditionalParent(
                                            condition: kDebugMode,
                                            builder: (child) {
                                              return Row(
                                                mainAxisAlignment:
                                                    MainAxisAlignment
                                                        .spaceBetween,
                                                children: [
                                                  child,
                                                  // CustomTextButton(
                                                  //   text: "Info",
                                                  //   onTap: () async {
                                                  //     final adr = await ref
                                                  //         .read(mainDBProvider)
                                                  //         .getAddress(walletId,
                                                  //             addresses.first);
                                                  //     if (adr != null &&
                                                  //         mounted) {
                                                  //       if (isDesktop) {
                                                  //         await showDialog<
                                                  //             void>(
                                                  //           context: context,
                                                  //           builder: (_) =>
                                                  //               DesktopDialog(
                                                  //             maxHeight: double
                                                  //                 .infinity,
                                                  //             child:
                                                  //                 AddressDetailsView(
                                                  //               addressId:
                                                  //                   adr.id,
                                                  //               walletId: widget
                                                  //                   .walletId,
                                                  //             ),
                                                  //           ),
                                                  //         );
                                                  //       } else {
                                                  //         await Navigator.of(
                                                  //                 context)
                                                  //             .pushNamed(
                                                  //           AddressDetailsView
                                                  //               .routeName,
                                                  //           arguments: Tuple2(
                                                  //             adr.id,
                                                  //             widget.walletId,
                                                  //           ),
                                                  //         );
                                                  //       }
                                                  //     }
                                                  //   },
                                                  // )
                                                ],
                                              );
                                            },
                                            child: Text(
                                              outputLabel,
                                              style: isDesktop
                                                  ? STextStyles
                                                      .desktopTextExtraExtraSmall(
                                                          context)
                                                  : STextStyles.itemSubtitle(
                                                      context),
                                            ),
                                          ),
                                          const SizedBox(
                                            height: 8,
                                          ),
                                          Column(
                                            crossAxisAlignment:
                                                CrossAxisAlignment.start,
                                            children: [
                                              if (data.length == 1 &&
                                                  data.first.addresses.length ==
                                                      1)
                                                FutureBuilder(
                                                  future: fetchContactNameFor(
                                                      data.first.addresses
                                                          .first),
                                                  builder: (builderContext,
                                                      AsyncSnapshot<String>
                                                          snapshot) {
                                                    String
                                                        addressOrContactName =
                                                        data.first.addresses
                                                            .first;
                                                    if (snapshot.connectionState ==
                                                            ConnectionState
                                                                .done &&
                                                        snapshot.hasData) {
                                                      addressOrContactName =
                                                          snapshot.data!;
                                                    }
                                                    return SelectableText(
                                                      addressOrContactName,
                                                      style: isDesktop
                                                          ? STextStyles
                                                                  .desktopTextExtraExtraSmall(
                                                                      context)
                                                              .copyWith(
                                                              color: Theme.of(
                                                                      context)
                                                                  .extension<
                                                                      StackColors>()!
                                                                  .textDark,
                                                            )
                                                          : STextStyles
                                                              .itemSubtitle12(
                                                                  context),
                                                    );
                                                  },
                                                )
                                              else
                                                for (int i = 0;
                                                    i < data.length;
                                                    i++)
                                                  ConditionalParent(
                                                    condition: i > 0,
                                                    builder: (child) => Column(
                                                      crossAxisAlignment:
                                                          CrossAxisAlignment
                                                              .stretch,
                                                      children: [
                                                        const _Divider(),
                                                        child,
                                                      ],
                                                    ),
                                                    child: Padding(
                                                      padding:
                                                          const EdgeInsets.all(
                                                              8.0),
                                                      child: Column(
                                                        crossAxisAlignment:
                                                            CrossAxisAlignment
                                                                .start,
                                                        children: [
                                                          ...data[i]
                                                              .addresses
                                                              .map(
                                                            (e) {
                                                              return FutureBuilder(
                                                                future:
                                                                    fetchContactNameFor(
                                                                        e),
                                                                builder: (builderContext,
                                                                    AsyncSnapshot<
                                                                            String>
                                                                        snapshot) {
                                                                  final String
                                                                      addressOrContactName;
                                                                  if (snapshot.connectionState ==
                                                                          ConnectionState
                                                                              .done &&
                                                                      snapshot
                                                                          .hasData) {
                                                                    addressOrContactName =
                                                                        snapshot
                                                                            .data!;
                                                                  } else {
                                                                    addressOrContactName =
                                                                        e;
                                                                  }

                                                                  return OutputCard(
                                                                    address:
                                                                        addressOrContactName,
                                                                    amount: data[
                                                                            i]
                                                                        .amount,
                                                                    coin: coin,
                                                                  );
                                                                },
                                                              );
                                                            },
                                                          ),
                                                        ],
                                                      ),
                                                    ),
                                                  ),
                                            ],
                                          ),
                                        ],
                                      ),
                                    ),
                                    // if (isDesktop)
                                    //   IconCopyButton(
                                    //     data: addresses.first,
                                    //   ),
                                  ],
                                ),
                              ),

                            isDesktop
                                ? const _Divider()
                                : const SizedBox(
                                    height: 12,
                                  ),
                            RoundedWhiteContainer(
                              padding: isDesktop
                                  ? const EdgeInsets.all(16)
                                  : const EdgeInsets.all(12),
                              child: Column(
                                crossAxisAlignment: CrossAxisAlignment.start,
                                children: [
                                  Row(
                                    mainAxisAlignment:
                                        MainAxisAlignment.spaceBetween,
                                    children: [
                                      Text(
                                        (coin == Coin.epicCash)
                                            ? "Local Note"
                                            : "Note ",
                                        style: isDesktop
                                            ? STextStyles
                                                .desktopTextExtraExtraSmall(
                                                    context)
                                            : STextStyles.itemSubtitle(context),
                                      ),
                                      isDesktop
                                          ? IconPencilButton(
                                              onPressed: () {
                                                showDialog<void>(
                                                  context: context,
                                                  builder: (context) {
                                                    return DesktopDialog(
                                                      maxWidth: 580,
                                                      maxHeight: 360,
                                                      child: EditNoteView(
                                                        txid: _transaction.txid,
                                                        walletId: walletId,
                                                      ),
                                                    );
                                                  },
                                                );
                                              },
                                            )
                                          : GestureDetector(
                                              onTap: () {
                                                Navigator.of(context).pushNamed(
                                                  EditNoteView.routeName,
                                                  arguments: Tuple2(
                                                    _transaction.txid,
                                                    walletId,
                                                  ),
                                                );
                                              },
                                              child: Row(
                                                children: [
                                                  SvgPicture.asset(
                                                    Assets.svg.pencil,
                                                    width: 10,
                                                    height: 10,
                                                    color: Theme.of(context)
                                                        .extension<
                                                            StackColors>()!
                                                        .infoItemIcons,
                                                  ),
                                                  const SizedBox(
                                                    width: 4,
                                                  ),
                                                  Text(
                                                    "Edit",
                                                    style: STextStyles.link2(
                                                        context),
                                                  ),
                                                ],
                                              ),
                                            ),
                                    ],
                                  ),
                                  const SizedBox(
                                    height: 8,
                                  ),
                                  SelectableText(
                                    ref
                                            .watch(
                                              pTransactionNote(
                                                (
                                                  txid: _transaction.txid,
                                                  walletId: walletId
                                                ),
                                              ),
                                            )
                                            ?.value ??
                                        "",
                                    style: isDesktop
                                        ? STextStyles
                                                .desktopTextExtraExtraSmall(
                                                    context)
                                            .copyWith(
                                            color: Theme.of(context)
                                                .extension<StackColors>()!
                                                .textDark,
                                          )
                                        : STextStyles.itemSubtitle12(context),
                                  ),
                                ],
                              ),
                            ),
                            isDesktop
                                ? const _Divider()
                                : const SizedBox(
                                    height: 12,
                                  ),
                            RoundedWhiteContainer(
                              padding: isDesktop
                                  ? const EdgeInsets.all(16)
                                  : const EdgeInsets.all(12),
                              child: Row(
                                mainAxisAlignment:
                                    MainAxisAlignment.spaceBetween,
                                crossAxisAlignment: CrossAxisAlignment.start,
                                children: [
                                  Column(
                                    crossAxisAlignment:
                                        CrossAxisAlignment.start,
                                    children: [
                                      Text(
                                        "Date",
                                        style: isDesktop
                                            ? STextStyles
                                                .desktopTextExtraExtraSmall(
                                                    context)
                                            : STextStyles.itemSubtitle(context),
                                      ),
                                      if (isDesktop)
                                        const SizedBox(
                                          height: 2,
                                        ),
                                      if (isDesktop)
                                        SelectableText(
                                          Format.extractDateFrom(
                                            _transaction.timestamp,
                                          ),
                                          style: isDesktop
                                              ? STextStyles
                                                      .desktopTextExtraExtraSmall(
                                                          context)
                                                  .copyWith(
                                                  color: Theme.of(context)
                                                      .extension<StackColors>()!
                                                      .textDark,
                                                )
                                              : STextStyles.itemSubtitle12(
                                                  context),
                                        ),
                                    ],
                                  ),
                                  if (!isDesktop)
                                    SelectableText(
                                      Format.extractDateFrom(
                                        _transaction.timestamp,
                                      ),
                                      style: isDesktop
                                          ? STextStyles
                                                  .desktopTextExtraExtraSmall(
                                                      context)
                                              .copyWith(
                                              color: Theme.of(context)
                                                  .extension<StackColors>()!
                                                  .textDark,
                                            )
                                          : STextStyles.itemSubtitle12(context),
                                    ),
                                  if (isDesktop)
                                    IconCopyButton(
                                      data: Format.extractDateFrom(
                                        _transaction.timestamp,
                                      ),
                                    ),
                                ],
                              ),
                            ),
                            if (coin != Coin.banano && coin != Coin.nano)
                              isDesktop
                                  ? const _Divider()
                                  : const SizedBox(
                                      height: 12,
                                    ),
                            if (coin != Coin.banano && coin != Coin.nano)
                              RoundedWhiteContainer(
                                padding: isDesktop
                                    ? const EdgeInsets.all(16)
                                    : const EdgeInsets.all(12),
                                child: Builder(builder: (context) {
                                  String feeString = showFeePending
                                      ? _transaction.isConfirmed(
                                          currentHeight,
                                          minConfirms,
                                        )
                                          ? ref
                                              .watch(pAmountFormatter(coin))
                                              .format(
                                                fee,
                                              )
                                          : "Pending"
                                      : ref
                                          .watch(pAmountFormatter(coin))
                                          .format(
                                            fee,
                                          );

                                  return Row(
                                    mainAxisAlignment:
                                        MainAxisAlignment.spaceBetween,
                                    crossAxisAlignment:
                                        CrossAxisAlignment.start,
                                    children: [
                                      Column(
                                        crossAxisAlignment:
                                            CrossAxisAlignment.start,
                                        children: [
                                          Text(
                                            "Transaction fee",
                                            style: isDesktop
                                                ? STextStyles
                                                    .desktopTextExtraExtraSmall(
                                                        context)
                                                : STextStyles.itemSubtitle(
                                                    context),
                                          ),
                                          if (isDesktop)
                                            const SizedBox(
                                              height: 2,
                                            ),
                                          if (isDesktop)
                                            SelectableText(
                                              feeString,
                                              style: isDesktop
                                                  ? STextStyles
                                                          .desktopTextExtraExtraSmall(
                                                              context)
                                                      .copyWith(
                                                      color: Theme.of(context)
                                                          .extension<
                                                              StackColors>()!
                                                          .textDark,
                                                    )
                                                  : STextStyles.itemSubtitle12(
                                                      context),
                                            ),
                                        ],
                                      ),
                                      if (!isDesktop)
                                        SelectableText(
                                          feeString,
                                          style: isDesktop
                                              ? STextStyles
                                                      .desktopTextExtraExtraSmall(
                                                          context)
                                                  .copyWith(
                                                  color: Theme.of(context)
                                                      .extension<StackColors>()!
                                                      .textDark,
                                                )
                                              : STextStyles.itemSubtitle12(
                                                  context),
                                        ),
                                      if (isDesktop)
                                        IconCopyButton(data: feeString)
                                    ],
                                  );
                                }),
                              ),
                            isDesktop
                                ? const _Divider()
                                : const SizedBox(
                                    height: 12,
                                  ),
                            RoundedWhiteContainer(
                              padding: isDesktop
                                  ? const EdgeInsets.all(16)
                                  : const EdgeInsets.all(12),
                              child: Builder(builder: (context) {
                                final String height;

                                if (widget.coin == Coin.bitcoincash ||
                                    widget.coin == Coin.eCash ||
                                    widget.coin == Coin.bitcoincashTestnet) {
                                  height =
                                      "${_transaction.height != null && _transaction.height! > 0 ? _transaction.height! : "Pending"}";
                                } else {
                                  height = widget.coin != Coin.epicCash &&
                                          _transaction.isConfirmed(
                                            currentHeight,
                                            minConfirms,
                                          )
                                      ? "${_transaction.height == 0 ? "Unknown" : _transaction.height}"
                                      : _transaction.getConfirmations(
                                                  currentHeight) >
                                              0
                                          ? "${_transaction.height}"
                                          : "Pending";
                                }

                                return Row(
                                  mainAxisAlignment:
                                      MainAxisAlignment.spaceBetween,
                                  crossAxisAlignment: CrossAxisAlignment.start,
                                  children: [
                                    Column(
                                      crossAxisAlignment:
                                          CrossAxisAlignment.start,
                                      children: [
                                        Text(
                                          "Block height",
                                          style: isDesktop
                                              ? STextStyles
                                                  .desktopTextExtraExtraSmall(
                                                      context)
                                              : STextStyles.itemSubtitle(
                                                  context),
                                        ),
                                        if (isDesktop)
                                          const SizedBox(
                                            height: 2,
                                          ),
                                        if (isDesktop)
                                          SelectableText(
                                            height,
                                            style: isDesktop
                                                ? STextStyles
                                                        .desktopTextExtraExtraSmall(
                                                            context)
                                                    .copyWith(
                                                    color: Theme.of(context)
                                                        .extension<
                                                            StackColors>()!
                                                        .textDark,
                                                  )
                                                : STextStyles.itemSubtitle12(
                                                    context),
                                          ),
                                      ],
                                    ),
                                    if (!isDesktop)
                                      SelectableText(
                                        height,
                                        style: isDesktop
                                            ? STextStyles
                                                    .desktopTextExtraExtraSmall(
                                                        context)
                                                .copyWith(
                                                color: Theme.of(context)
                                                    .extension<StackColors>()!
                                                    .textDark,
                                              )
                                            : STextStyles.itemSubtitle12(
                                                context),
                                      ),
                                    if (isDesktop) IconCopyButton(data: height),
                                  ],
                                );
                              }),
                            ),

                            if (kDebugMode)
                              isDesktop
                                  ? const _Divider()
                                  : const SizedBox(
                                      height: 12,
                                    ),
                            if (kDebugMode)
                              RoundedWhiteContainer(
                                padding: isDesktop
                                    ? const EdgeInsets.all(16)
                                    : const EdgeInsets.all(12),
                                child: Row(
                                  crossAxisAlignment: CrossAxisAlignment.start,
                                  mainAxisAlignment:
                                      MainAxisAlignment.spaceBetween,
                                  children: [
                                    Text(
                                      "Tx sub type",
                                      style: isDesktop
                                          ? STextStyles
                                              .desktopTextExtraExtraSmall(
                                                  context)
                                          : STextStyles.itemSubtitle(context),
                                    ),
                                    SelectableText(
                                      _transaction.subType.toString(),
                                      style: isDesktop
                                          ? STextStyles
                                                  .desktopTextExtraExtraSmall(
                                                      context)
                                              .copyWith(
                                              color: Theme.of(context)
                                                  .extension<StackColors>()!
                                                  .textDark,
                                            )
                                          : STextStyles.itemSubtitle12(context),
                                    ),
                                  ],
                                ),
                              ),
                            isDesktop
                                ? const _Divider()
                                : const SizedBox(
                                    height: 12,
                                  ),
                            RoundedWhiteContainer(
                              padding: isDesktop
                                  ? const EdgeInsets.all(16)
                                  : const EdgeInsets.all(12),
                              child: Row(
                                crossAxisAlignment: CrossAxisAlignment.start,
                                mainAxisAlignment:
                                    MainAxisAlignment.spaceBetween,
                                children: [
                                  Expanded(
                                    child: Column(
                                      crossAxisAlignment:
                                          CrossAxisAlignment.start,
                                      children: [
                                        Text(
                                          "Transaction ID",
                                          style: isDesktop
                                              ? STextStyles
                                                  .desktopTextExtraExtraSmall(
                                                      context)
                                              : STextStyles.itemSubtitle(
                                                  context),
                                        ),
                                        const SizedBox(
                                          height: 8,
                                        ),
                                        // Flexible(
                                        //   child: FittedBox(
                                        //     fit: BoxFit.scaleDown,
                                        //     child:
                                        SelectableText(
                                          _transaction.txid,
                                          style: isDesktop
                                              ? STextStyles
                                                      .desktopTextExtraExtraSmall(
                                                          context)
                                                  .copyWith(
                                                  color: Theme.of(context)
                                                      .extension<StackColors>()!
                                                      .textDark,
                                                )
                                              : STextStyles.itemSubtitle12(
                                                  context),
                                        ),
                                        if (coin != Coin.epicCash)
                                          const SizedBox(
                                            height: 8,
                                          ),
                                        if (coin != Coin.epicCash)
                                          CustomTextButton(
                                            text: "Open in block explorer",
                                            onTap: () async {
                                              final uri =
                                                  getBlockExplorerTransactionUrlFor(
                                                coin: coin,
                                                txid: _transaction.txid,
                                              );

                                              if (ref
                                                      .read(
                                                          prefsChangeNotifierProvider)
                                                      .hideBlockExplorerWarning ==
                                                  false) {
                                                final shouldContinue =
                                                    await showExplorerWarning(
                                                        "${uri.scheme}://${uri.host}");

                                                if (!shouldContinue) {
                                                  return;
                                                }
                                              }

                                              // ref
                                              //     .read(
                                              //         shouldShowLockscreenOnResumeStateProvider
                                              //             .state)
                                              //     .state = false;
                                              try {
                                                await launchUrl(
                                                  uri,
                                                  mode: LaunchMode
                                                      .externalApplication,
                                                );
                                              } catch (_) {
                                                if (mounted) {
                                                  unawaited(
                                                    showDialog<void>(
                                                      context: context,
                                                      builder: (_) =>
                                                          StackOkDialog(
                                                        title:
                                                            "Could not open in block explorer",
                                                        message:
                                                            "Failed to open \"${uri.toString()}\"",
                                                      ),
                                                    ),
                                                  );
                                                }
                                              } finally {
                                                // Future<void>.delayed(
                                                //   const Duration(seconds: 1),
                                                //   () => ref
                                                //       .read(
                                                //           shouldShowLockscreenOnResumeStateProvider
                                                //               .state)
                                                //       .state = true,
                                                // );
                                              }
                                            },
                                          ),
                                        //   ),
                                        // ),
                                      ],
                                    ),
                                  ),
                                  if (isDesktop)
                                    const SizedBox(
                                      width: 12,
                                    ),
                                  if (isDesktop)
                                    IconCopyButton(
                                      data: _transaction.txid,
                                    ),
                                ],
                              ),
                            ),
                            // if ((coin == Coin.firoTestNet || coin == Coin.firo) &&
                            //     _transaction.subType == "mint")
                            //   const SizedBox(
                            //     height: 12,
                            //   ),
                            // if ((coin == Coin.firoTestNet || coin == Coin.firo) &&
                            //     _transaction.subType == "mint")
                            //   RoundedWhiteContainer(
                            //     child: Column(
                            //       crossAxisAlignment: CrossAxisAlignment.start,
                            //       children: [
                            //         Row(
                            //           mainAxisAlignment: MainAxisAlignment.spaceBetween,
                            //           children: [
                            //             Text(
                            //               "Mint Transaction ID",
                            //               style: STextStyles.itemSubtitle(context),
                            //             ),
                            //           ],
                            //         ),
                            //         const SizedBox(
                            //           height: 8,
                            //         ),
                            //         // Flexible(
                            //         //   child: FittedBox(
                            //         //     fit: BoxFit.scaleDown,
                            //         //     child:
                            //         SelectableText(
                            //           _transaction.otherData ?? "Unknown",
                            //           style: STextStyles.itemSubtitle12(context),
                            //         ),
                            //         //   ),
                            //         // ),
                            //         const SizedBox(
                            //           height: 8,
                            //         ),
                            //         BlueTextButton(
                            //           text: "Open in block explorer",
                            //           onTap: () async {
                            //             final uri = getBlockExplorerTransactionUrlFor(
                            //               coin: coin,
                            //               txid: _transaction.otherData ?? "Unknown",
                            //             );
                            //             // ref
                            //             //     .read(
                            //             //         shouldShowLockscreenOnResumeStateProvider
                            //             //             .state)
                            //             //     .state = false;
                            //             try {
                            //               await launchUrl(
                            //                 uri,
                            //                 mode: LaunchMode.externalApplication,
                            //               );
                            //             } catch (_) {
                            //               unawaited(showDialog<void>(
                            //                 context: context,
                            //                 builder: (_) => StackOkDialog(
                            //                   title: "Could not open in block explorer",
                            //                   message:
                            //                       "Failed to open \"${uri.toString()}\"",
                            //                 ),
                            //               ));
                            //             } finally {
                            //               // Future<void>.delayed(
                            //               //   const Duration(seconds: 1),
                            //               //   () => ref
                            //               //       .read(
                            //               //           shouldShowLockscreenOnResumeStateProvider
                            //               //               .state)
                            //               //       .state = true,
                            //               // );
                            //             }
                            //           },
                            //         ),
                            //       ],
                            //     ),
                            //   ),

                            if (!isDesktop)
                              const SizedBox(
                                height: 12,
                              ),
                          ],
                        ),
                      ),
                    ),
                  ),
                ),
              ),
            ],
          ),
        ),
      ),
    );
  }
}

class OutputCard extends ConsumerWidget {
  const OutputCard({
    super.key,
    required this.address,
    required this.amount,
    required this.coin,
  });

  final String address;
  final Amount amount;
  final Coin coin;

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Text(
          "Address",
          style: Util.isDesktop
              ? STextStyles.desktopTextExtraExtraSmall(context)
              : STextStyles.itemSubtitle(context),
        ),
        SelectableText(
          address,
          style: Util.isDesktop
              ? STextStyles.desktopTextExtraExtraSmall(context).copyWith(
                  color: Theme.of(context).extension<StackColors>()!.textDark,
                )
              : STextStyles.itemSubtitle12(context),
        ),
        const SizedBox(
          height: 10,
        ),
        Row(
          mainAxisAlignment: MainAxisAlignment.spaceBetween,
          children: [
            Text(
              "Amount",
              style: Util.isDesktop
                  ? STextStyles.desktopTextExtraExtraSmall(context)
                  : STextStyles.itemSubtitle(context),
            ),
            SelectableText(
              ref.watch(pAmountFormatter(coin)).format(amount),
              style: Util.isDesktop
                  ? STextStyles.desktopTextExtraExtraSmall(context).copyWith(
                      color:
                          Theme.of(context).extension<StackColors>()!.textDark,
                    )
                  : STextStyles.itemSubtitle12(context),
            ),
          ],
        )
      ],
    );
  }
}

class _Divider extends StatelessWidget {
  const _Divider({Key? key}) : super(key: key);

  @override
  Widget build(BuildContext context) {
    return Container(
      height: 1,
      color: Theme.of(context).extension<StackColors>()!.backgroundAppBar,
    );
  }
}

class IconCopyButton extends StatelessWidget {
  const IconCopyButton({
    Key? key,
    required this.data,
  }) : super(key: key);

  final String data;

  @override
  Widget build(BuildContext context) {
    return SizedBox(
      height: 26,
      width: 26,
      child: RawMaterialButton(
        fillColor:
            Theme.of(context).extension<StackColors>()!.buttonBackSecondary,
        elevation: 0,
        hoverElevation: 0,
        shape: RoundedRectangleBorder(
          borderRadius: BorderRadius.circular(6),
        ),
        onPressed: () async {
          await Clipboard.setData(ClipboardData(text: data));
          if (context.mounted) {
            unawaited(
              showFloatingFlushBar(
                type: FlushBarType.info,
                message: "Copied to clipboard",
                context: context,
              ),
            );
          }
        },
        child: Padding(
          padding: const EdgeInsets.all(5),
          child: CopyIcon(
            width: 16,
            height: 16,
            color: Theme.of(context).extension<StackColors>()!.textDark,
          ),
        ),
      ),
    );
  }
}

class IconPencilButton extends StatelessWidget {
  const IconPencilButton({
    Key? key,
    this.onPressed,
  }) : super(key: key);

  final VoidCallback? onPressed;

  @override
  Widget build(BuildContext context) {
    return SizedBox(
      height: 26,
      width: 26,
      child: RawMaterialButton(
        fillColor:
            Theme.of(context).extension<StackColors>()!.buttonBackSecondary,
        elevation: 0,
        hoverElevation: 0,
        shape: RoundedRectangleBorder(
          borderRadius: BorderRadius.circular(6),
        ),
        onPressed: () => onPressed?.call(),
        child: Padding(
          padding: const EdgeInsets.all(5),
          child: PencilIcon(
            width: 16,
            height: 16,
            color: Theme.of(context).extension<StackColors>()!.textDark,
          ),
        ),
      ),
    );
  }
}
